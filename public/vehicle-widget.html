<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vehicle Widget</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:12px}
    select{margin:6px 0;padding:6px;width:240px}
    .row{margin-bottom:8px}
  </style>
</head>
<body>
  <h3>Vehicle Selector</h3>
  <div class="row">
    <label for="years">Year</label><br>
    <select id="years"><option>Loading...</option></select>
  </div>
  <div class="row">
    <label for="makes">Make</label><br>
    <select id="makes" disabled><option>Select year first</option></select>
  </div>
  <div class="row">
    <label for="models">Model</label><br>
    <select id="models" disabled><option>Select make first</option></select>
  </div>
  <script>
    const base = window.VEHICLE_API_BASE || '';
    const yearsEl = document.getElementById('years');
    const makesEl = document.getElementById('makes');
    const modelsEl = document.getElementById('models');

    async function fetchJson(url) {
      const r = await fetch(url, { credentials: 'same-origin' });
      if (!r.ok) throw new Error('Fetch error ' + r.status);
      return r.json();
    }

    function populate(selectEl, items, placeholder) {
      selectEl.innerHTML = '';
      if (!items || items.length === 0) {
        selectEl.disabled = true;
        const o = document.createElement('option'); o.textContent = placeholder || 'No items'; selectEl.appendChild(o);
        return;
      }
      selectEl.disabled = false;
      const dflt = document.createElement('option'); dflt.textContent = '— select —'; dflt.value = ''; selectEl.appendChild(dflt);
      for (const it of items) {
        const o = document.createElement('option'); o.value = it.id; o.textContent = it.name; selectEl.appendChild(o);
      }
    }

    async function loadYears() {
      try {
        populate(yearsEl, [], 'Loading...');
        const data = await fetchJson(base + '/functions/vehicle/years');
        populate(yearsEl, data.items || [], 'No years');
      } catch (e) {
        populate(yearsEl, [], 'Error loading');
        console.error(e);
      }
    }

    yearsEl.addEventListener('change', async () => {
      const year = yearsEl.value;
      if (!year) return populate(makesEl, [], 'Select year first');
      populate(makesEl, [], 'Loading...');
      populate(modelsEl, [], 'Select make first');
      try {
        const data = await fetchJson(base + `/functions/vehicle/makes?year=${encodeURIComponent(year)}`);
        populate(makesEl, data.items || [], 'No makes');
      } catch (e) {
        populate(makesEl, [], 'Error');
        console.error(e);
      }
    });

    makesEl.addEventListener('change', async () => {
      const year = yearsEl.value; const make = makesEl.value;
      if (!make) return populate(modelsEl, [], 'Select make first');
      populate(modelsEl, [], 'Loading...');
      try {
        const data = await fetchJson(base + `/functions/vehicle/models?year=${encodeURIComponent(year)}&make=${encodeURIComponent(make)}`);
        populate(modelsEl, data.items || [], 'No models');
      } catch (e) {
        populate(modelsEl, [], 'Error');
        console.error(e);
      }
    });

    // bootstrap
    loadYears();
  </script>
</body>
</html>
