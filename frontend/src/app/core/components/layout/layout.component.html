<!-- Mobile-First Responsive Layout Template -->

<!-- App Container -->
<div class="app-container">
  
  <!-- Top Header - Sticky on all devices -->
  <header class="app-header">
    <div class="header-content">
      <!-- Mobile Menu Toggle -->
      <button class="menu-toggle show-mobile-only" (click)="toggleMobileMenu()" aria-label="Toggle Menu">
        <svg *ngIf="!isMobileMenuOpen" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg *ngIf="isMobileMenuOpen" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      
      <!-- Logo/Brand -->
      <div class="brand">
        <mtr-banner></mtr-banner>
      </div>
      
      <!-- Desktop Actions -->
      <div class="header-actions hide-mobile">
        <mtr-nav-header *ngIf="(userSettingsService.hamburgerMenuMode$ | async) === 'Enabled'"></mtr-nav-header>
      </div>
    </div>
    
    <!-- Search Bar - Full width on mobile -->
    <div class="search-container">
      <mtr-search-form [class.v-hidden]="!(vehicleSelectionFacade.activeVehicleId$ | async)"></mtr-search-form>
    </div>
  </header>
  
  <!-- Filter Tabs - Horizontal scroll on mobile -->
  <mtr-filter-tabs 
    class="filter-tabs-bar"
    [class.v-hidden]="!(vehicleSelectionFacade.activeVehicleId$ | async)">
  </mtr-filter-tabs>
  
  <!-- Main Content Area -->
  <main class="main-content">
    
    <!-- Sidebar / Navigation Panel -->
    <aside 
      class="sidebar"
      [class.sidebar-open]="isSidebarOpen || isMobileMenuOpen"
      [class.sidebar-collapsed]="!isSidebarOpen && !isMobileMenuOpen">
      
      <!-- Sidebar Header with Vehicle Info -->
      <div class="sidebar-header">
        <ng-container *ngIf="modelSelector$ | async as selectedVehicle">
          <div class="selected-vehicle">
            <svg class="vehicle-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 17H4C3.45 17 2.98 16.78 2.59 16.41C2.22 16.02 2 15.55 2 15V11L4.48 5.22C4.64 4.84 5 4.5 5.5 4.5H18.5C19 4.5 19.36 4.84 19.52 5.22L22 11V15C22 15.55 21.78 16.02 21.41 16.41C21.02 16.78 20.55 17 20 17H19" stroke="currentColor" stroke-width="1.5"/>
              <circle cx="7.5" cy="19.5" r="1.5" fill="currentColor"/>
              <circle cx="16.5" cy="19.5" r="1.5" fill="currentColor"/>
            </svg>
            <a class="vehicle-link" [routerLink]="['/vehicles']" *ngIf="(userSettingsService.ymmeSelectorMode$ | async) === 'Link'">
              {{ selectedVehicle }}
            </a>
            <span class="vehicle-text" *ngIf="(userSettingsService.ymmeSelectorMode$ | async) !== 'Link'">
              {{ selectedVehicle }}
            </span>
          </div>
        </ng-container>
        
        <!-- Desktop Toggle Button -->
        <button class="sidebar-toggle hide-mobile" (click)="toggleSidebar()" aria-label="Toggle Sidebar">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      
      <!-- Navigation Tree -->
      <nav class="sidebar-nav">
        <mtr-search-results-panel *ngFor="let _ of [searchPanelRecreationTrigger$ | async]"></mtr-search-results-panel>
      </nav>
    </aside>
    
    <!-- Backdrop for mobile menu -->
    <div 
      class="sidebar-backdrop show-mobile-only"
      *ngIf="isMobileMenuOpen"
      (click)="closeMobileMenu()">
    </div>
    
    <!-- Content Panel -->
    <section class="content-panel">
      <!-- Article/Content Area -->
      <ng-container *ngIf="(assetsFacade.hasContentId$ | async) || (assetsFacade.isMaintenanceScheduleTab$ | async); else dashboardOrSplash">
        
        <!-- Top Controls for Article View -->
        <div class="content-header">
          <div class="content-header-left">
            <span *ngIf="assetsFacade.isBookmarkOutdated$ | async" class="alert-badge">
              <svg class="icon-sm" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"/>
              </svg>
              There is a
              <a [routerLink]="[]" [queryParams]="{ bookmarkId: null }" queryParamsHandling="merge">
                newer article available
              </a>
            </span>
            
            <span *ngIf="assetsFacade.showLicenseMessageForToyota$ | async" class="license-message">
              {{ assetsFacade.toyotaLicenseMessage }}
            </span>
          </div>
          
          <div class="content-header-right">
            <!-- Engine/Submodel Selector -->
            <select
              *ngIf="shouldDisplayEngineSubModelSelector$ | async"
              class="form-select form-select-sm"
              [ngModel]="vehicleSelectionFacade.motorVehicleId$ | async"
              (ngModelChange)="vehicleSelectionFacade.setMotorVehicleId($event)">
              <option disabled [ngValue]="undefined">Select Engine/Submodel</option>
              <option *ngFor="let vehicle of modelDetails$ | async" [value]="vehicle.id">
                {{ vehicle.model }}
              </option>
            </select>
            
            <span *ngIf="isMotorVehicleModel$ | async" class="motor-model-badge">
              {{ motorModelSelector$ | async }}
            </span>
            
            <!-- Expand/Collapse Controls -->
            <button 
              *ngIf="assetsFacade.hasContentId$ | async"
              class="icon-btn hide-mobile"
              (click)="layoutFacade.toggleRightExpandCollapse()"
              [attr.aria-label]="(layoutFacade.isRightExpanded$ | async) ? 'Collapse' : 'Expand'">
              <svg *ngIf="!(layoutFacade.isRightExpanded$ | async)" viewBox="0 0 24 24" fill="none">
                <path d="M4 20h16M4 12h16M4 4h16" stroke="currentColor" stroke-width="2"/>
              </svg>
              <svg *ngIf="layoutFacade.isRightExpanded$ | async" viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
            
            <mtr-article-toolbox
              *ngIf="assetsFacade.activeArticleId$ | async"
              iframeSelector="#articleContainer iframe">
            </mtr-article-toolbox>
          </div>
        </div>
        
        <!-- Article Container -->
        <div class="article-container">
          <mtr-horizontal-circles-loader
            *ngIf="(assetsFacade.rootLoading$ | async) || IsAwaitingApiResponse; else articleDisplay">
          </mtr-horizontal-circles-loader>
          
          <ng-template #articleDisplay>
            <div *ngIf="assetsFacade.laborError$ | async as errorMessage" class="error-message">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <p>{{ errorMessage['status'] === 404 ? 'Your account has not licensed access to labor data.' : 'Unable to display the requested document.' }}</p>
            </div>
            
            <mtr-labor-operation 
              *ngIf="assetsFacade.labor$ | async as labor"
              [labor]="labor">
            </mtr-labor-operation>
            
            <mtr-maintenance-schedules
              *ngIf="(assetsFacade.isMaintenanceScheduleTab$ | async) && !(shouldDisplayEngineSubModelSelector$ | async)">
            </mtr-maintenance-schedules>
            
            <mtr-dynamic-article-html
              *ngIf="((assetsFacade.rootHtml$ | async) && !(assetsFacade.rootHtmlIsFullPage$ | async)) || (assetsFacade.rootError$ | async)"
              class="article-{{ vehicleSelectionFacade.contentSource$ | async }}"
              [html$]="assetsFacade.rootHtml$"
              [error$]="assetsFacade.rootError$">
            </mtr-dynamic-article-html>
            
            <mtr-dynamic-article-html-iframe
              *ngIf="assetsFacade.rootHtmlIsFullPage$ | async"
              [html$]="assetsFacade.rootHtml$">
            </mtr-dynamic-article-html-iframe>
            
            <ngx-extended-pdf-viewer
              *ngIf="assetsFacade.base64Pdf$ | async"
              [base64Src]="(assetsFacade.base64Pdf$ | async)!"
              [useBrowserLocale]="true"
              [showDownloadButton]="false"
              [showOpenFileButton]="false"
              [showPropertiesButton]="false"
              [showRotateButton]="false"
              [showSecondaryToolbarButton]="false"
              [textLayer]="true"
              [showPrintButton]="!detectMobile()"
              [showDownloadButton]="detectMobile()">
            </ngx-extended-pdf-viewer>
          </ng-template>
        </div>
      </ng-container>
      
      <!-- Dashboard or Splash Screen -->
      <ng-template #dashboardOrSplash>
        <ng-container *ngIf="vehicleSelectionFacade.activeVehicleId$ | async; else defaultSplash">
          <mtr-vehicle-dashboard></mtr-vehicle-dashboard>
        </ng-container>
        <ng-template #defaultSplash>
          <div class="splash-screen">
            <img [src]="userSettingsService.splashUrl$ | async" alt="Motor M1" />
          </div>
        </ng-template>
      </ng-template>
    </section>
    
  </main>
  
  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav show-mobile-only" *ngIf="vehicleSelectionFacade.activeVehicleId$ | async">
    <button class="nav-item" (click)="toggleMobileMenu()" [class.active]="isMobileMenuOpen">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Menu</span>
    </button>
    
    <a class="nav-item" [routerLink]="['/vehicles']">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M5 17H4C3.45 17 2.98 16.78 2.59 16.41C2.22 16.02 2 15.55 2 15V11L4.48 5.22C4.64 4.84 5 4.5 5.5 4.5H18.5C19 4.5 19.36 4.84 19.52 5.22L22 11V15C22 15.55 21.78 16.02 21.41 16.41C21.02 16.78 20.55 17 20 17H19" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="7.5" cy="19.5" r="1.5" fill="currentColor"/>
        <circle cx="16.5" cy="19.5" r="1.5" fill="currentColor"/>
      </svg>
      <span>Vehicle</span>
    </a>
    
    <a class="nav-item" [routerLink]="[]" [queryParams]="{articleIdTrail: '-998'}" queryParamsHandling="merge">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Service</span>
    </a>
    
    <button class="nav-item" (click)="openSearch()">
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Search</span>
    </button>
  </nav>
  
</div>

<!-- Modals -->
<mtr-article-modal *ngIf="assetsFacade.hasBreadcrumb$ | async"></mtr-article-modal>
<mtr-geo-blocking-modal 
  *ngIf="searchResultsFacade.displayRestrictedContentAlert$ | async as geoBlockStatus"
  [geoBlockStatus]="geoBlockStatus">
</mtr-geo-blocking-modal>
