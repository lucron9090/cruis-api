name: Self-Hosted CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: self-hosted
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter (if available)
        run: npm run lint || echo "No lint script found"
        continue-on-error: true
      
      - name: Run tests
        run: npm test
        continue-on-error: true
      
      - name: Build application
        run: npm run build || echo "No build script found"
        continue-on-error: true
      
      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: dist-${{ matrix.node-version }}
          path: |
            dist
            build
            *.js
            package.json
            package-lock.json
          retention-days: 7

  health-check:
    runs-on: self-hosted
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Start server in background
        run: |
          nohup npm start > server.log 2>&1 &
          echo $! > server.pid
          sleep 5
      
      - name: Health check
        run: |
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3001/health; then
              echo "Health check passed"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt failed, retrying..."
            sleep 2
          done
          echo "Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
      
      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: server.log
          retention-days: 3

  deploy:
    runs-on: self-hosted
    needs: [build-and-test, health-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --production
      
      - name: Deploy notification
        run: |
          echo "Deploying cruis-api to Firebase"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"
      
      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # Check if either FIREBASE_TOKEN or service account is available
          if [ -z "$FIREBASE_TOKEN" ] && [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "âš ï¸  Neither FIREBASE_TOKEN nor FIREBASE_SERVICE_ACCOUNT is set."
            echo "Skipping Firebase deployment."
            echo ""
            echo "To enable Firebase deployment, add one of these to GitHub secrets:"
            echo "  1. FIREBASE_TOKEN - Generate with: firebase login:ci"
            echo "  2. FIREBASE_SERVICE_ACCOUNT - Your Firebase service account JSON"
            exit 0
          fi
          
          echo "ðŸš€ Deploying to Firebase..."
          
          # If service account JSON is provided, create credentials file
          if [ -n "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
            echo "âœ“ Using Firebase service account for authentication"
          else
            echo "âœ“ Using Firebase CI token for authentication"
          fi
          
          chmod +x ./deploy.sh
          ./deploy.sh
          
          # Clean up credentials file if created
          if [ -f /tmp/firebase-service-account.json ]; then
            rm -f /tmp/firebase-service-account.json
          fi
          
          echo "âœ… Firebase deployment completed"
